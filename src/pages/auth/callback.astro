---
/**
 * Auth Callback page
 *
 * Handles OAuth and magic link callbacks
 * - Exchanges token for session
 * - Sets authentication cookies
 * - Redirects to destination or home page
 */

import Layout from "@/layouts/Layout.astro";

const supabase = Astro.locals.supabase;
const { searchParams } = Astro.url;

// Extract parameters from URL - support multiple Supabase auth flows
const token_hash = searchParams.get("token_hash");
const token = searchParams.get("token"); // Old format
const code = searchParams.get("code"); // PKCE flow
const type = searchParams.get("type");
const redirect = searchParams.get("redirect") || "/";

// Log ALL parameters for debugging
console.log("=== Auth Callback Debug ===");
console.log("1. All URL params:", Object.fromEntries(searchParams.entries()));
console.log("2. Token hash:", token_hash ? "present" : "missing");
console.log("3. Token (old format):", token ? "present" : "missing");
console.log("4. Code (PKCE flow):", code ? "present" : "missing");
console.log("5. Type:", type);
console.log("6. Redirect:", redirect);

// Check if we have PKCE code (most common for Supabase Cloud)
if (code) {
  console.log("7. Using PKCE flow - exchanging code for session");
  const { data, error } = await supabase.auth.exchangeCodeForSession(code);

  console.log("8. PKCE exchange response:", {
    hasData: !!data,
    hasSession: !!data?.session,
    hasUser: !!data?.user,
    userId: data?.user?.id,
    error: error?.message,
  });

  if (error) {
    console.error("PKCE code exchange error:", error);
    const errorMessage = error.message.toLowerCase().includes("expired") ? "expired_token" : "verification_failed";
    return Astro.redirect(`/auth/error?message=${errorMessage}&details=${encodeURIComponent(error.message)}`);
  }

  if (!data?.session) {
    console.error("No session created after PKCE exchange");
    return Astro.redirect("/auth/error?message=no_session");
  }

  // Verify the session was actually set by checking again
  console.log("9. Verifying session was set...");
  const {
    data: { user: verifyUser },
  } = await supabase.auth.getUser();
  console.log("10. Session verification:", {
    userExists: !!verifyUser,
    userId: verifyUser?.id,
    email: verifyUser?.email,
  });

  if (!verifyUser) {
    console.error("Session was created but not persisted in cookies!");
    return Astro.redirect("/auth/error?message=session_not_persisted");
  }

  console.log("11. PKCE Success! Redirecting to:", redirect);
  return Astro.redirect(redirect);
}

// Check if we have token format (older flow)
const hasToken = token_hash || token;

// Validate required parameters for OTP flow
if (!hasToken || !type) {
  console.error("Missing authentication parameters. Received params:", Object.fromEntries(searchParams.entries()));
  return Astro.redirect("/auth/error?message=invalid_token");
}

// Validate token type
const validTypes = ["magiclink", "recovery", "invite", "signup", "email"];
if (!validTypes.includes(type)) {
  console.error("Invalid token type:", type);
  return Astro.redirect("/auth/error?message=invalid_token_type");
}

// OTP flow - Verify the token (older flow, less common)
console.log("7. Using OTP flow - verifying token");
let data, error;

if (token_hash) {
  // New format: use token_hash
  console.log("8. Using token_hash format");
  const result = await supabase.auth.verifyOtp({
    token_hash,
    type: type as "magiclink" | "recovery" | "invite" | "signup" | "email",
  });
  data = result.data;
  error = result.error;
} else if (token) {
  // Old format: use token
  console.log("8. Using token format (old)");
  const result = await supabase.auth.verifyOtp({
    token_hash: token,
    type: type as "magiclink" | "recovery" | "invite" | "signup" | "email",
  });
  data = result.data;
  error = result.error;
}

console.log("9. OTP verification response:", {
  hasData: !!data,
  hasSession: !!data?.session,
  hasUser: !!data?.user,
  error: error?.message,
});

// Handle verification errors
if (error) {
  console.error("OTP verification error:", error);
  const errorMessage = error.message.toLowerCase().includes("expired") ? "expired_token" : "verification_failed";
  return Astro.redirect(`/auth/error?message=${errorMessage}&details=${encodeURIComponent(error.message)}`);
}

// Check if session was created
if (!data?.session) {
  console.error("No session created after OTP verification");
  return Astro.redirect("/auth/error?message=no_session");
}

// Success! Session is automatically set via cookies by the Supabase client
console.log("10. OTP Success! Redirecting to:", redirect);
return Astro.redirect(redirect);
---

<Layout title="Logowanie... - YogaFit">
  <main class="min-h-screen flex items-center justify-center bg-gradient-yoga p-4">
    <div class="max-w-md w-full space-y-8">
      <!-- Loading state -->
      <div class="text-center space-y-6">
        <div
          class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-primary/10 border-2 border-primary/20 animate-pulse"
        >
          <span class="text-6xl" aria-hidden="true">üîê</span>
        </div>

        <div class="space-y-3">
          <h1
            class="font-display text-3xl font-bold bg-gradient-to-r from-primary via-accent to-secondary text-transparent bg-clip-text"
          >
            Trwa logowanie...
          </h1>
          <p class="text-lg text-muted-foreground font-body">Sprawdzamy Twoje dane</p>
        </div>

        <!-- Loading spinner -->
        <div class="backdrop-blur-xl bg-card/80 rounded-3xl shadow-float p-8 border border-border/50">
          <div class="flex flex-col items-center gap-4">
            <div class="relative w-16 h-16">
              <div class="absolute inset-0 border-4 border-primary/20 rounded-full"></div>
              <div class="absolute inset-0 border-4 border-primary border-t-transparent rounded-full animate-spin">
              </div>
            </div>
            <p class="text-sm text-muted-foreground">To potrwa tylko chwilƒô...</p>
          </div>
        </div>

        <!-- Info note -->
        <div class="backdrop-blur-xl bg-card/60 rounded-2xl p-5 border border-border/30">
          <p class="text-xs text-muted-foreground text-center leading-relaxed">
            <strong class="text-foreground">Uwaga:</strong> Je≈õli strona nie przekierowuje automatycznie,{" "}
            <a
              href="/"
              class="text-primary hover:text-primary/80 underline decoration-primary/30 hover:decoration-primary transition-colors"
            >
              kliknij tutaj
            </a>
            {" "}aby przej≈õƒá do strony g≈Ç√≥wnej.
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- Auto-redirect script (temporary until backend is implemented) -->
  <script is:inline>
    /* Placeholder: Auto-redirect after 2 seconds */ /* TODO: Remove when backend callback is implemented */
    setTimeout(function () {
      // Placeholder function
    }, 2000);
  </script>
</Layout>
