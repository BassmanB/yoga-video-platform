---
/**
 * Auth Callback page
 *
 * Handles OAuth and magic link callbacks
 * - Exchanges token for session
 * - Sets authentication cookies
 * - Redirects to destination or home page
 */

import Layout from "@/layouts/Layout.astro";

const supabase = Astro.locals.supabase;
const { searchParams } = Astro.url;

// Extract parameters from URL
const token_hash = searchParams.get("token_hash");
const type = searchParams.get("type");
const redirect = searchParams.get("redirect") || "/";

console.log("=== Auth Callback Debug ===");
console.log("1. Token hash:", token_hash ? "present" : "missing");
console.log("2. Type:", type);
console.log("3. Redirect:", redirect);

// Validate required parameters
if (!token_hash || !type) {
  console.error("Missing token_hash or type parameter");
  return Astro.redirect("/auth/error?message=invalid_token");
}

// Validate token type
const validTypes = ["magiclink", "recovery", "invite", "signup"];
if (!validTypes.includes(type)) {
  console.error("Invalid token type:", type);
  return Astro.redirect("/auth/error?message=invalid_token_type");
}

// Verify the OTP token
console.log("4. Calling verifyOtp...");
const { data, error } = await supabase.auth.verifyOtp({
  token_hash,
  type: type as "magiclink" | "recovery" | "invite" | "signup",
});

console.log("5. Verification response:", {
  hasData: !!data,
  hasSession: !!data?.session,
  hasUser: !!data?.user,
  error: error?.message,
});

// Handle verification errors
if (error) {
  console.error("Auth callback error:", error);
  const errorMessage = error.message.toLowerCase().includes("expired") ? "expired_token" : "verification_failed";
  return Astro.redirect(`/auth/error?message=${errorMessage}&details=${encodeURIComponent(error.message)}`);
}

// Check if session was created
if (!data.session) {
  console.error("No session created after verification");
  return Astro.redirect("/auth/error?message=no_session");
}

// Success! Session is automatically set via cookies by the Supabase client
console.log("6. Success! Redirecting to:", redirect);
return Astro.redirect(redirect);
---

<Layout title="Logowanie... - YogaFit">
  <main class="min-h-screen flex items-center justify-center bg-gradient-yoga p-4">
    <div class="max-w-md w-full space-y-8">
      <!-- Loading state -->
      <div class="text-center space-y-6">
        <div
          class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-primary/10 border-2 border-primary/20 animate-pulse"
        >
          <span class="text-6xl" aria-hidden="true">üîê</span>
        </div>

        <div class="space-y-3">
          <h1
            class="font-display text-3xl font-bold bg-gradient-to-r from-primary via-accent to-secondary text-transparent bg-clip-text"
          >
            Trwa logowanie...
          </h1>
          <p class="text-lg text-muted-foreground font-body">Sprawdzamy Twoje dane</p>
        </div>

        <!-- Loading spinner -->
        <div class="backdrop-blur-xl bg-card/80 rounded-3xl shadow-float p-8 border border-border/50">
          <div class="flex flex-col items-center gap-4">
            <div class="relative w-16 h-16">
              <div class="absolute inset-0 border-4 border-primary/20 rounded-full"></div>
              <div class="absolute inset-0 border-4 border-primary border-t-transparent rounded-full animate-spin">
              </div>
            </div>
            <p class="text-sm text-muted-foreground">To potrwa tylko chwilƒô...</p>
          </div>
        </div>

        <!-- Info note -->
        <div class="backdrop-blur-xl bg-card/60 rounded-2xl p-5 border border-border/30">
          <p class="text-xs text-muted-foreground text-center leading-relaxed">
            <strong class="text-foreground">Uwaga:</strong> Je≈õli strona nie przekierowuje automatycznie,{" "}
            <a
              href="/"
              class="text-primary hover:text-primary/80 underline decoration-primary/30 hover:decoration-primary transition-colors"
            >
              kliknij tutaj
            </a>
            {" "}aby przej≈õƒá do strony g≈Ç√≥wnej.
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- Auto-redirect script (temporary until backend is implemented) -->
  <script is:inline>
    /* Placeholder: Auto-redirect after 2 seconds */ /* TODO: Remove when backend callback is implemented */
    setTimeout(function () {
      // Placeholder function
    }, 2000);
  </script>
</Layout>
